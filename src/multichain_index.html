<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ethereum Multichain API Dapp</title>
  </head>
  <body>
    <h1>Ethereum Multichain API Dapp</h1>
    <input type="text" id="connectExtensionInput" value="nonfpcflonapegmnfeafnddgdniflbnk" />
    <br>
    <button id="connectExtensionButton">Connect Extension</button>
    <br>
    <div id="connectedExtension">Connected Extension: Not available</div>
    <br><br>
    <button id="connectRequestFullButton">full</button>
    <button id="connectRequestMixedButton">mixed</button>
    <button id="connectRequestOnlySendButton">only eth_sendTransaction</button>
    <button id="connectRequestOnlySubscribeButton">only eth_subscribe</button>
    <br>
    <textarea id="connectRequestTextarea" rows="25" cols="80"></textarea>
    <br>
    <button id="connectButton">Connect Wallet</button>
    <br><br>
    <div id="connectedAccounts">Connected Accounts: Not available</div>
    <br><br>
    <label for="scopeSelect">Select Scope:</label>
    <select id="scopeSelect"></select>
    <br><br>
    <button id="sendTxButton">Send 0 Ether to Null Address</button>
    <br><br>
    <button id="subscribeButton">Subscribe to Block Head</button>
    <br><br>
    <div id="subscriptionsContainer"></div>
    <script>
      let extensionPort;
      let jsonRpcId;
      let accounts = [];
      let scopeStrings = [];

      // Dapp <-> Wallet Connection Initialization
      async function connectExtension() {
        const extensionId = document.getElementById("connectExtensionInput").value;
        try {
          extensionPort = chrome.runtime.connect(extensionId); // externally_connectable
          extensionPort.onMessage.addListener((msg) => {
            const { data: { method, params } } = msg;
            // Subscription Events
            if (method === "wallet_notify") {
              handleEthSubscriptionDisplay(
                params.scope,
                params.notification.params.result.number,
              );
              // Permission Events
            } else if (method === "wallet_sessionChanged") {
              onNewSessionScopes(params.sessionScopes);
            }
            console.log(msg.data);
          });

          // Dapp Initialization
          checkWalletConnection();
        } catch (error) {
          console.error(error);
          alert("Failed to connect to extension!");
        }
      }

      // Permission Handling
      async function onNewSessionScopes(sessionScopes) {
        const oldScopeStrings = scopeStrings;
        const eip155ScopeStrings = Object.keys(sessionScopes).filter((scopeString) =>
          /eip155:[0-9]+/u.test(scopeString),
        );

        const eip155AccountsSet = new Set();

        eip155ScopeStrings.forEach((scopeString) => {
          const scopeObject = sessionScopes[scopeString];

          scopeObject.accounts.forEach((account) => {
            const address = account.split(":")[2];
            eip155AccountsSet.add(address);
          });
        });

        accounts = [...eip155AccountsSet];
        scopeStrings = [...eip155ScopeStrings];

        updateConnectedAccountsDisplay();
        updateScopeSelectOptions();

        oldScopeStrings.forEach((oldScopeString) => {
          if (!scopeStrings.includes(oldScopeString)) {
            removeEthSubscriptionDisplay(oldScopeString);
          }
        });
      }

      // Permission Initialization
      async function connectWallet() {
        if (!extensionPort) {
          alert("Connect to extension first.");
          return;
        }
        try {
          const textarea = document.getElementById("connectRequestTextarea");
          const params = JSON.parse(textarea.value);

          const { sessionScopes } = await extensionPortRequest({
            method: "wallet_createSession",
            params,
          });

          await onNewSessionScopes(sessionScopes);
        } catch (error) {
          console.error(error);
          alert("Failed to connect wallet!");
        }
      }

      async function checkWalletConnection() {
        try {
          const { sessionScopes } = await extensionPortRequest({
            method: "wallet_getSession",
          });
          await onNewSessionScopes(sessionScopes);
        } catch (error) {
          console.error("Failed to check wallet connection:", error);
          alert("Failed to check wallet connection");
        }
      }

      //
      // Example Usage
      //

      // Transaction
      async function sendTransaction() {
        if (accounts.length === 0) {
          alert("Please connect your wallet first!");
          return;
        }

        const selectedScope = document.getElementById("scopeSelect").value;

        const transactionParameters = {
          to: "0x0000000000000000000000000000000000000000",
          from: accounts[0],
          value: "0x0",
        };

        try {
          alert(`Will make eth_sendTransaction request intended for ${selectedScope} after this alert is dismissed.`);
          await extensionPortRequest({
            method: "wallet_invokeMethod",
            params: {
              scope: selectedScope,
              request: {
                method: "eth_sendTransaction",
                params: [transactionParameters],
              },
            },
          });
          alert("Transaction sent!");
        } catch (error) {
          console.error(error);
          alert("Transaction failed!");
        }
      }

      // Subscription
      async function subscribeToBlockHeaders() {
        const selectedScope = document.getElementById("scopeSelect").value;
        if (!selectedScope) {
          return;
        }

        const scopeContainerId = `subscriptionsContainer-${selectedScope}`;
        const scopeContainer = document.getElementById(scopeContainerId);
        if (scopeContainer) {
          return;
        }

        try {
          await extensionPortRequest({
            method: "wallet_invokeMethod",
            params: {
              scope: selectedScope,
              request: {
                method: "eth_subscribe",
                params: ["newHeads"],
              },
            },
          });
          handleEthSubscriptionDisplay(selectedScope);
        } catch (error) {
          console.error(error);
          alert("Subscription failed!");
        }
      }

      //
      // externally_connectable helpers:
      // normally this would be abstracted away
      // by a helper library
      //

      function generateJsonRpcId(opts) {
        let max = Number.MAX_SAFE_INTEGER;
        jsonRpcId = jsonRpcId ?? Math.floor(Math.random() * max);

        jsonRpcId = jsonRpcId % max;
        jsonRpcId += 1;
        return jsonRpcId;
      }

      async function extensionPortRequest(request) {
        const id = generateJsonRpcId();

        extensionPort.postMessage({
          type: "caip-x",
          data: {
            jsonrpc: "2.0",
            id,
            ...request,
          },
        });

        return new Promise((resolve, reject) => {
          const listener = (msg) => {
            if (msg.type === "caip-x" && msg.data.id === id) {
              const { result, error } = msg.data;
              if (result) {
                resolve(result);
              } else {
                reject(error);
              }
              extensionPort.onMessage.removeListener(listener);
            }
          };

          extensionPort.onMessage.addListener(listener);
        });
      }

      //
      // Everything below is ignorable boilerplate
      //

      // DOM
      document.getElementById("connectExtensionButton").addEventListener("click", connectExtension);
      document.getElementById("sendTxButton").addEventListener("click", sendTransaction);
      document.getElementById("subscribeButton").addEventListener("click", subscribeToBlockHeaders);
      document.getElementById("connectButton").addEventListener("click", connectWallet);
      document.getElementById("connectRequestFullButton").addEventListener("click", connectRequestFull);
      document.getElementById("connectRequestMixedButton").addEventListener("click", connectRequestMixed);
      document.getElementById("connectRequestOnlySendButton").addEventListener("click", connectRequestOnlySend);
      document.getElementById("connectRequestOnlySubscribeButton").addEventListener("click", connectRequestOnlySubscribe);

      // DOM Helpers
      function updateScopeSelectOptions() {
        const select = document.getElementById("scopeSelect");
        select.innerHTML = "";

        scopeStrings.forEach((scopeString) => {
          const opt = document.createElement("option");
          opt.value = scopeString;
          opt.innerHTML = scopeString;
          select.appendChild(opt);
        });
      }

      function updateConnectedAccountsDisplay() {
        if (accounts.length > 0) {
          document.getElementById("connectedAccounts").innerText = `Connected Accounts: ${accounts.join(", ")}`;
        } else {
          document.getElementById("connectedAccounts").innerText = `Connected Accounts: Not available`;
        }
      }

      async function removeEthSubscriptionDisplay(scope) {
        const scopeContainerId = `subscriptionsContainer-${scope}`;
        const scopeContainer = document.getElementById(scopeContainerId);
        if (scopeContainer) {
          scopeContainer.remove();
        }
      }

      async function handleEthSubscriptionDisplay(scope, value = "Not available") {
        const scopeContainerId = `subscriptionsContainer-${scope}`;
        let scopeContainer = document.getElementById(scopeContainerId);

        if (!scopeContainer) {
          const subscriptionsContainer = document.getElementById(
            "subscriptionsContainer",
          );
          scopeContainer = document.createElement("div");
          scopeContainer.id = scopeContainerId;
          scopeContainer.style.display = "inline-block";
          scopeContainer.style.margin = "15px 15px 15px 0";
          scopeContainer.style.padding = "5px";
          scopeContainer.style.border = "1px solid black";
          subscriptionsContainer.appendChild(scopeContainer);
        }

        scopeContainer.innerHTML = `
                      <b>${scope}</b>
                      <br>
                      Block Number: ${value}
                    `;
        scopeContainer.style.border = "1px solid red";
        setTimeout(() => {
          scopeContainer.style.border = "1px solid black";
        }, 1500);
      }

      function connectRequestFull() {
        const params = {
          optionalScopes: {
            eip155: {
              references: ["1", "59141", "11155111", "59144"],
              methods: [
                "personal_sign",
                "eth_signTypedData_v4",
                "wallet_watchAsset",
                "eth_sendTransaction",
                "eth_subscribe",
                "eth_unsubscribe",
              ],
              notifications: ["eth_subscription"],
            },
          },
        };

        const textarea = document.getElementById("connectRequestTextarea");
        textarea.value = JSON.stringify(params, null, 2);
      }

      function connectRequestMixed() {
        const params = {
          optionalScopes: {
            "eip155:1": {
              methods: ["eth_sendTransaction", "eth_subscribe"],
              notifications: ["eth_subscription"],
            },
            "eip155:59141": {
              methods: ["eth_sendTransaction"],
              notifications: [],
            },
            "eip155:11155111": {
              methods: ["eth_subscribe"],
              notifications: ["eth_subscription"],
            },
            "eip155:59144": {
              methods: ["eth_call"],
              notifications: [],
            },
          },
        };

        const textarea = document.getElementById("connectRequestTextarea");
        textarea.value = JSON.stringify(params, null, 2);
      }

      function connectRequestOnlySend() {
        const params = {
          optionalScopes: {
            eip155: {
              references: ["1", "59141", "11155111", "59144"],
              methods: ["eth_sendTransaction"],
              notifications: [],
            },
          },
        };

        const textarea = document.getElementById("connectRequestTextarea");
        textarea.value = JSON.stringify(params, null, 2);
      }

      function connectRequestOnlySubscribe() {
        const params = {
          optionalScopes: {
            eip155: {
              references: ["1", "59141", "11155111", "59144"],
              methods: ["eth_subscribe"],
              notifications: ["eth_subscription"],
            },
          },
        };

        const textarea = document.getElementById("connectRequestTextarea");
        textarea.value = JSON.stringify(params, null, 2);
      }

      // DOM Initialization
      connectRequestFull();
    </script>
  </body>
</html>
